<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muscat Bay Water Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f7;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #4E4456 0%, #7A6B84 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #8B7A94 0%, #A596AD 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .metric-card {
            text-align: center;
            border-top: 4px solid #4E4456;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4E4456;
            margin: 0.5rem 0;
        }

        .metric-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-change {
            font-size: 0.9rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
            margin-top: 0.5rem;
        }

        .positive {
            background: #e6f4ea;
            color: #1e7e34;
        }

        .negative {
            background: #fce4e4;
            color: #cc0000;
        }

        .section-title {
            font-size: 1.8rem;
            color: #4E4456;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
            font-size: 1rem;
            white-space: nowrap;
        }

        .tab.active {
            color: #4E4456;
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #4E4456;
        }

        .simple-chart {
            margin: 2rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 300px;
            margin: 1rem 0;
            border-bottom: 2px solid #333;
            position: relative;
        }

        .bar {
            width: 60px;
            background: #4E4456;
            margin: 0 10px;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
        }

        .bar:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }

        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            font-size: 0.9rem;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #4E4456;
            position: sticky;
            top: 0;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        tr:hover {
            background: #f8f9fa;
        }

        td {
            vertical-align: middle;
        }

        .zone-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .zone-01 { background: #e3f2fd; color: #1976d2; }
        .zone-03a { background: #f3e5f5; color: #7b1fa2; }
        .zone-03b { background: #e8f5e9; color: #388e3c; }
        .zone-05 { background: #fff3e0; color: #f57c00; }
        .zone-08 { background: #fce4ec; color: #c2185b; }
        .zone-vs { background: #e0f2f1; color: #00796b; }

        .filter-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 1rem;
        }

        .hierarchy-diagram {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .hierarchy-level {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .hierarchy-node {
            background: white;
            border: 2px solid #4E4456;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            min-width: 150px;
            position: relative;
        }

        .hierarchy-node.l1 {
            background: #4E4456;
            color: white;
        }

        .hierarchy-node.l2 {
            background: #7A6B84;
            color: white;
        }

        .hierarchy-node.dc {
            background: #A596AD;
            color: white;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: #4E4456;
            transition: width 0.3s ease;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .pie-chart {
            width: 300px;
            height: 300px;
            margin: 2rem auto;
            position: relative;
        }

        .pie-slice {
            position: absolute;
            width: 300px;
            height: 300px;
            border-radius: 50%;
        }

        .pie-legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 2rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .consumption-bar-container {
            position: relative;
            width: 100%;
            height: 28px;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .consumption-bar {
            height: 100%;
            border-radius: 0 4px 4px 0;
            transition: width 0.3s ease, opacity 0.2s ease;
            position: relative;
            min-width: 50px;
        }

        .consumption-bar:hover {
            opacity: 0.9;
        }

        .consumption-value {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 600;
            font-size: 0.8rem;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.4);
        }

        .consumption-low { background: #2ecc71; }
        .consumption-medium { background: #f1c40f; }
        .consumption-high { background: #e74c3c; }

        input[type="text"] {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            width: 200px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #4E4456;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding: 1rem 0;
            border-top: 1px solid #e0e0e0;
        }

        .pagination-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #4E4456;
            color: white;
            border-color: #4E4456;
        }

        .pagination-btn:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .page-info {
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            border-radius: 4px;
            font-weight: 500;
        }

        .meter-stats {
            margin-top: 1rem;
            text-align: center;
            color: #666;
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 4px;
        }

        .meter-stats strong {
            font-weight: bold;
        }

        .meter-stats .total { color: #4E4456; }
        .meter-stats .active { color: #4caf50; }
        .meter-stats .inactive { color: #f44336; }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .hierarchy-level {
                flex-direction: column;
                align-items: center;
            }
            
            input[type="text"] {
                width: 100%;
                max-width: 200px;
            }

            .pagination-controls {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>
            <div class="logo">MB</div>
            Muscat Bay Water Management System
        </h1>
        <p>Real-time water distribution monitoring and loss analysis dashboard</p>
    </header>

    <div class="container">
        <div class="filter-controls">
            <select id="periodSelect" class="filter-select" style="background: #4E4456; color: white; border: none;">
                <option value="Apr-25">Apr-25</option>
                <option value="Mar-25">Mar-25</option>
                <option value="Feb-25">Feb-25</option>
                <option value="Jan-25">Jan-25</option>
                <option value="Dec-24">Dec-24</option>
                <option value="Nov-24">Nov-24</option>
            </select>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">Overview</button>
            <button class="tab" onclick="showTab('zones')">Zone Analysis</button>
            <button class="tab" onclick="showTab('analysis')">Trend Analysis</button>
            <button class="tab" onclick="showTab('consumers')">Top Consumers</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <h2 class="section-title">
                <span>üìä</span> System Overview - <span id="selectedPeriod">Apr-25</span>
            </h2>
            
            <div id="alertSection"></div>
            
            <div class="dashboard-grid">
                <div class="card metric-card">
                    <div class="metric-label">Total Supply (L1)</div>
                    <div class="metric-value" id="totalSupply">0</div>
                    <div class="metric-label">m¬≥</div>
                    <div id="supplyChange" class="metric-change negative">Loading...</div>
                </div>

                <div class="card metric-card">
                    <div class="metric-label">Distribution (L2+DC)</div>
                    <div class="metric-value" id="totalDistribution">0</div>
                    <div class="metric-label">m¬≥</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="distributionProgress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="card metric-card">
                    <div class="metric-label">Consumption (L3+DC)</div>
                    <div class="metric-value" id="totalConsumption">0</div>
                    <div class="metric-label">m¬≥</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="consumptionProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <h2 class="section-title">
                <span>üíß</span> Water Loss Analysis
            </h2>

            <div class="dashboard-grid">
                <div class="card">
                    <h3>Stage 1 Loss (Trunk Main)</h3>
                    <p style="font-size: 2rem; color: #388e3c; margin: 1rem 0;">
                        <span id="stage1Loss">0</span> m¬≥
                    </p>
                    <p>Percentage: <strong id="stage1Percentage">0%</strong></p>
                    <p style="color: #666; font-size: 0.9rem;">Loss between main source and distribution points</p>
                </div>

                <div class="card">
                    <h3>Stage 2 Loss (Distribution)</h3>
                    <p style="font-size: 2rem; color: #f57c00; margin: 1rem 0;">
                        <span id="stage2Loss">0</span> m¬≥
                    </p>
                    <p>Percentage: <strong id="stage2Percentage">0%</strong></p>
                    <p style="color: #666; font-size: 0.9rem;">Loss within zones between bulk and end users</p>
                </div>

                <div class="card">
                    <h3>Total System Loss</h3>
                    <p style="font-size: 2rem; color: #d32f2f; margin: 1rem 0;">
                        <span id="totalLoss">0</span> m¬≥
                    </p>
                    <p>Percentage: <strong id="totalLossPercentage">0%</strong></p>
                    <p style="color: #666; font-size: 0.9rem;">Overall non-revenue water</p>
                </div>
            </div>

            <div class="card">
                <h3>Water Distribution Hierarchy</h3>
                <div class="hierarchy-diagram">
                    <div class="hierarchy-node l1">
                        <strong>L1 - Main Bulk (NAMA)</strong>
                        <br />
                        <span id="hierarchyL1">0</span> m¬≥
                        <br />
                        <small>100% of supply</small>
                    </div>
                    
                    <div style="font-size: 2rem; margin: 1rem 0; color: #4E4456;">‚Üì</div>
                    
                    <div class="hierarchy-level">
                        <div class="hierarchy-node l2">
                            <strong>L2 - Zone Bulks</strong>
                            <br />
                            <span id="hierarchyL2">0</span> m¬≥
                            <br />
                            <small>6 zones</small>
                        </div>
                        <div class="hierarchy-node dc">
                            <strong>DC - Direct Connections</strong>
                            <br />
                            <span id="hierarchyDC">0</span> m¬≥
                            <br />
                            <small>Hotel, Irrigation, etc.</small>
                        </div>
                    </div>
                    
                    <div style="font-size: 2rem; margin: 1rem 0; color: #4E4456;">‚Üì</div>
                    
                    <div class="hierarchy-node">
                        <strong>L3 + DC - End Users</strong>
                        <br />
                        <span id="hierarchyEndUsers">0</span> m¬≥
                        <br />
                        <small>332 meters total</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Zones Tab -->
        <div id="zones" class="tab-content">
            <h2 class="section-title">
                <span>üèòÔ∏è</span> Zone Performance Analysis
            </h2>

            <!-- Zone and Month Filters -->
            <div class="filter-controls">
                <select id="zoneSelect" class="filter-select" style="background: #7A6B84; color: white; border: none;">
                    <option value="Zone_01_(FM)">Zone 01 (FM)</option>
                    <option value="Zone_03_(A)">Zone 03A</option>
                    <option value="Zone_03_(B)">Zone 03B</option>
                    <option value="Zone_05">Zone 05</option>
                    <option value="Zone_08">Zone 08</option>
                    <option value="Zone_VS">Village Square</option>
                    <option value="Main_Bulk">Main Bulk (A2)</option>
                </select>
                <select id="zoneMonthSelect" class="filter-select">
                    <option value="Apr-25">Apr-25</option>
                    <option value="Mar-25">Mar-25</option>
                    <option value="Feb-25">Feb-25</option>
                    <option value="Jan-25">Jan-25</option>
                    <option value="Dec-24">Dec-24</option>
                    <option value="Nov-24">Nov-24</option>
                </select>
            </div>

            <!-- Zone KPI Cards -->
            <div class="dashboard-grid" style="margin-top: 2rem;">
                <div class="card metric-card">
                    <div class="metric-label">Zone Bulk Reading</div>
                    <div class="metric-value" id="zoneBulkReading">0</div>
                    <div class="metric-label">m¬≥</div>
                </div>

                <div class="card metric-card">
                    <div class="metric-label">Total Individual Consumption</div>
                    <div class="metric-value" id="zoneIndividualSum">0</div>
                    <div class="metric-label">m¬≥</div>
                </div>

                <div class="card metric-card" style="border-top-color: #cc0000;">
                    <div class="metric-label">Water Loss</div>
                    <div class="metric-value" id="zoneLoss" style="color: #cc0000;">0</div>
                    <div class="metric-label">m¬≥</div>
                </div>

                <div class="card metric-card" style="border-top-color: #cc0000;">
                    <div class="metric-label">Loss Percentage</div>
                    <div class="metric-value" id="zoneLossPercentage" style="color: #cc0000;">0%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="zoneLossBar" style="width: 0%; background: #cc0000;"></div>
                    </div>
                </div>
            </div>

            <!-- Zone Performance Chart -->
            <div class="card" style="margin-top: 2rem;">
                <h3>Zone Performance Visualization - Water Distribution</h3>
                <div class="simple-chart">
                    <div style="display: flex; justify-content: space-around; align-items: flex-end; height: 300px; padding: 20px;">
                        <div style="text-align: center;">
                            <div id="bulkBar" style="width: 80px; background: #4E4456; margin: 0 auto; position: relative; border-radius: 4px 4px 0 0; height: 200px;">
                                <div class="bar-value" style="top: -25px;">0</div>
                            </div>
                            <div style="margin-top: 10px; font-weight: bold;">Bulk Reading</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="individualBar" style="width: 80px; background: #7A6B84; margin: 0 auto; position: relative; border-radius: 4px 4px 0 0; height: 180px;">
                                <div class="bar-value" style="top: -25px;">0</div>
                            </div>
                            <div style="margin-top: 10px; font-weight: bold;">Individual Sum</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="lossBar" style="width: 80px; background: #cc0000; margin: 0 auto; position: relative; border-radius: 4px 4px 0 0; height: 50px;">
                                <div class="bar-value" style="top: -25px; color: #cc0000;">0</div>
                            </div>
                            <div style="margin-top: 10px; font-weight: bold; color: #cc0000;">Loss</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Individual Meters Table -->
            <div class="card" style="margin-top: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>Individual Meters Detail</h3>
                    <input type="text" id="meterSearch" placeholder="Search meters..." style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>METER LABEL</th>
                                <th>ACCOUNT #</th>
                                <th style="text-align: right;">CONSUMPTION (M¬≥)</th>
                                <th style="width: 350px;">CONSUMPTION UNITS</th>
                            </tr>
                        </thead>
                        <tbody id="meterTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                <div class="pagination-controls">
                    <div style="color: #666;">
                        Showing <span id="showingStart">1</span>-<span id="showingEnd">12</span> of <span id="totalMetersCount">0</span> meters
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button id="prevPageBtn" class="pagination-btn" onclick="changeMeterPage(-1)">
                            ‚Üê Previous
                        </button>
                        <span class="page-info">
                            Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                        </span>
                        <button id="nextPageBtn" class="pagination-btn" onclick="changeMeterPage(1)">
                            Next ‚Üí
                        </button>
                    </div>
                </div>
                
                <div class="meter-stats">
                    <small>
                        <strong>Total Meters:</strong> <span id="totalMeters" class="total">0</span> | 
                        <strong>Active:</strong> <span id="activeMeters" class="active">0</span> | 
                        <strong>Inactive:</strong> <span id="inactiveMeters" class="inactive">0</span>
                    </small>
                </div>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis" class="tab-content">
            <h2 class="section-title">
                <span>üìà</span> Trend Analysis
            </h2>

            <div class="card">
                <h3>Monthly Water Supply Trend</h3>
                <div class="simple-chart">
                    <div class="bar-chart" id="trendChart">
                        <!-- Bars will be inserted by JavaScript -->
                    </div>
                </div>
            </div>

            <div class="dashboard-grid" style="margin-top: 2rem;">
                <div class="card">
                    <h3>System Efficiency</h3>
                    <div class="pie-chart" style="text-align: center;">
                        <div style="font-size: 4rem; color: #4E4456; font-weight: bold;">
                            <span id="efficiencyPercent">0</span>%
                        </div>
                        <p style="color: #666; margin-top: 1rem;">Water Delivered to End Users</p>
                        <div class="progress-bar" style="width: 200px; margin: 2rem auto;">
                            <div class="progress-fill" id="efficiencyBar" style="width: 0%; background: #4E4456;"></div>
                        </div>
                    </div>
                    <div class="pie-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4E4456;"></div>
                            <span>Delivered: <strong id="deliveredPercent">0%</strong></span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #cc0000;"></div>
                            <span>Lost: <strong id="lostPercent">0%</strong></span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Loss Breakdown by Stage</h3>
                    <div class="simple-chart">
                        <div style="margin: 2rem 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                <span>Stage 1 Loss</span>
                                <strong id="stage1Amount">0 m¬≥</strong>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="stage1Bar" style="width: 0%; background: #7A6B84;"></div>
                            </div>
                        </div>
                        <div style="margin: 2rem 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                <span>Stage 2 Loss</span>
                                <strong id="stage2Amount">0 m¬≥</strong>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="stage2Bar" style="width: 0%; background: #A596AD;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Consumers Tab -->
        <div id="consumers" class="tab-content">
            <h2 class="section-title">
                <span>üè¢</span> Top Consumers - April 2025
            </h2>

            <div class="card">
                <h3>Top 10 Water Consumers</h3>
                <table style="margin-top: 1rem;">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Consumer</th>
                            <th>Type</th>
                            <th>Consumption (m¬≥)</th>
                            <th>% of Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>Hotel Main Building</td>
                            <td><span class="zone-badge" style="background: #e3f2fd; color: #1976d2;">Retail</span></td>
                            <td style="text-align: right; font-weight: bold;">27,676</td>
                            <td style="text-align: right;">60.3%</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>STP Building</td>
                            <td><span class="zone-badge" style="background: #f3e5f5; color: #7b1fa2;">Utility</span></td>
                            <td style="text-align: right; font-weight: bold;">1,200</td>
                            <td style="text-align: right;">2.6%</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Irrigation Controller UP</td>
                            <td><span class="zone-badge" style="background: #f3e5f5; color: #7b1fa2;">IRR_Services</span></td>
                            <td style="text-align: right; font-weight: bold;">1,000</td>
                            <td style="text-align: right;">2.2%</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>Al Adrak Camp</td>
                            <td><span class="zone-badge" style="background: #e3f2fd; color: #1976d2;">Retail</span></td>
                            <td style="text-align: right; font-weight: bold;">1,000</td>
                            <td style="text-align: right;">2.2%</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>Al Adrak Construction</td>
                            <td><span class="zone-badge" style="background: #e3f2fd; color: #1976d2;">Retail</span></td>
                            <td style="text-align: right; font-weight: bold;">600</td>
                            <td style="text-align: right;">1.3%</td>
                        </tr>
                        <tr>
                            <td>6</td>
                            <td>Irrigation Controller DOWN</td>
                            <td><span class="zone-badge" style="background: #f3e5f5; color: #7b1fa2;">IRR_Services</span></td>
                            <td style="text-align: right; font-weight: bold;">411</td>
                            <td style="text-align: right;">0.9%</td>
                        </tr>
                        <tr>
                            <td>7</td>
                            <td>Z8-5 (Villa)</td>
                            <td><span class="zone-badge" style="background: #e8f5e9; color: #388e3c;">Residential</span></td>
                            <td style="text-align: right; font-weight: bold;">336</td>
                            <td style="text-align: right;">0.7%</td>
                        </tr>
                        <tr>
                            <td>8</td>
                            <td>Building CIF/CB</td>
                            <td><span class="zone-badge" style="background: #e3f2fd; color: #1976d2;">Retail</span></td>
                            <td style="text-align: right; font-weight: bold;">307</td>
                            <td style="text-align: right;">0.7%</td>
                        </tr>
                        <tr>
                            <td>9</td>
                            <td>Z3-31 (Villa)</td>
                            <td><span class="zone-badge" style="background: #e8f5e9; color: #388e3c;">Residential</span></td>
                            <td style="text-align: right; font-weight: bold;">306</td>
                            <td style="text-align: right;">0.7%</td>
                        </tr>
                        <tr>
                            <td>10</td>
                            <td>Building B8</td>
                            <td><span class="zone-badge" style="background: #e3f2fd; color: #1976d2;">Retail</span></td>
                            <td style="text-align: right; font-weight: bold;">261</td>
                            <td style="text-align: right;">0.6%</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="alert alert-warning" style="margin-top: 2rem;">
                <strong>Key Insight:</strong> The Hotel Main Building alone consumes 60.3% of total end-user consumption (27,676 m¬≥ out of 45,863 m¬≥). 
                This single consumer represents a critical monitoring point for the system.
            </div>

            <div class="card" style="margin-top: 2rem;">
                <h3>Consumption by Type</h3>
                <div class="simple-chart">
                    <div class="bar-chart" id="typeChart" style="height: 250px;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
       // Accurate water data from CSV analysis - Complete 2024-2025 Dataset
const waterData = {
    'Jan-24': { L1: 32803, L2: 11964, DC: 16725, L3: 8955 },
    'Feb-24': { L1: 27996, L2: 10292, DC: 14781, L3: 7120 },
    'Mar-24': { L1: 23860, L2: 11087, DC: 12920, L3: 6706 },
    'Apr-24': { L1: 31869, L2: 13380, DC: 15333, L3: 8251 },
    'May-24': { L1: 30737, L2: 11785, DC: 16304, L3: 7388 },
    'Jun-24': { L1: 41953, L2: 15699, DC: 18927, L3: 8938 },
    'Jul-24': { L1: 35166, L2: 18370, DC: 16319, L3: 9642 },
    'Aug-24': { L1: 35420, L2: 15292, DC: 16306, L3: 8634 },
    'Sep-24': { L1: 41341, L2: 14173, DC: 17640, L3: 8064 },
    'Oct-24': { L1: 31519, L2: 13588, DC: 20937, L3: 9570 },
    'Nov-24': { L1: 35290, L2: 11203, DC: 17501, L3: 8891 },
    'Dec-24': { L1: 36733, L2: 15095, DC: 16014, L3: 9545 },
    'Jan-25': { L1: 32580, L2: 15327, DC: 19998, L3: 7900 },
    'Feb-25': { L1: 44043, L2: 14716, DC: 21095, L3: 7274 },
    'Mar-25': { L1: 34915, L2: 15290, DC: 24275, L3: 7989 },
    'Apr-25': { L1: 46039, L2: 15031, DC: 30832, L3: 8140 }
};

// Accurate zone data from actual CSV files - Complete Dataset
const detailedZoneData = {
    'Zone_01_(FM)': {
        name: 'Zone 01 (FM)',
        'Jan-24': { bulk: 1595, individual: 1624, loss: -29 },
        'Feb-24': { bulk: 1283, individual: 1010, loss: 273 },
        'Mar-24': { bulk: 1255, individual: 985, loss: 270 },
        'Apr-24': { bulk: 1383, individual: 1070, loss: 313 },
        'May-24': { bulk: 1411, individual: 1168, loss: 243 },
        'Jun-24': { bulk: 2078, individual: 1414, loss: 664 },
        'Jul-24': { bulk: 2601, individual: 2128, loss: 473 },
        'Aug-24': { bulk: 1638, individual: 1418, loss: 220 },
        'Sep-24': { bulk: 1550, individual: 1274, loss: 276 },
        'Oct-24': { bulk: 2098, individual: 1570, loss: 528 },
        'Nov-24': { bulk: 1808, individual: 1648, loss: 160 },
        'Dec-24': { bulk: 1946, individual: 1880, loss: 66 },
        'Jan-25': { bulk: 2008, individual: 1898, loss: 110 },
        'Feb-25': { bulk: 1740, individual: 1648, loss: 92 },
        'Mar-25': { bulk: 1880, individual: 1817, loss: 63 },
        'Apr-25': { bulk: 1880, individual: 1629, loss: 251 },
        meters: [
            { label: 'Building FM', account: '4300296', type: 'MB_Common', 'Apr-25': 40, 'Mar-25': 49, 'Feb-25': 39, 'Jan-25': 37, status: 'active' },
            { label: 'Building Taxi', account: '4300298', type: 'Retail', 'Apr-25': 14, 'Mar-25': 12, 'Feb-25': 16, 'Jan-25': 11, status: 'active' },
            { label: 'Building B1', account: '4300300', type: 'Retail', 'Apr-25': 253, 'Mar-25': 235, 'Feb-25': 225, 'Jan-25': 228, status: 'active' },
            { label: 'Building B2', account: '4300301', type: 'Retail', 'Apr-25': 187, 'Mar-25': 202, 'Feb-25': 213, 'Jan-25': 236, status: 'active' },
            { label: 'Building B3', account: '4300302', type: 'Retail', 'Apr-25': 134, 'Mar-25': 132, 'Feb-25': 165, 'Jan-25': 169, status: 'active' },
            { label: 'Building B4', account: '4300303', type: 'Retail', 'Apr-25': 148, 'Mar-25': 148, 'Feb-25': 108, 'Jan-25': 108, status: 'active' },
            { label: 'Building B5', account: '4300304', type: 'Retail', 'Apr-25': 1, 'Mar-25': 1, 'Feb-25': 2, 'Jan-25': 1, status: 'active' },
            { label: 'Building B6', account: '4300305', type: 'Retail', 'Apr-25': 281, 'Mar-25': 268, 'Feb-25': 228, 'Jan-25': 254, status: 'active' },
            { label: 'Building B7', account: '4300306', type: 'Retail', 'Apr-25': 201, 'Mar-25': 174, 'Feb-25': 190, 'Jan-25': 178, status: 'active' },
            { label: 'Building B8', account: '4300307', type: 'Retail', 'Apr-25': 0, 'Mar-25': 233, 'Feb-25': 250, 'Jan-25': 268, status: 'inactive' },
            { label: 'Irrigation Tank (Z01_FM)', account: '4300308', type: 'IRR_Services', 'Apr-25': 0, 'Mar-25': 0, 'Feb-25': 0, 'Jan-25': 0, status: 'inactive' },
            { label: 'Room PUMP (FIRE)', account: '4300309', type: 'MB_Common', 'Apr-25': 0, 'Mar-25': 0, 'Feb-25': 0, 'Jan-25': 78, status: 'inactive' },
            { label: 'Building (MEP)', account: '4300310', type: 'MB_Common', 'Apr-25': 5, 'Mar-25': 1, 'Feb-25': 2, 'Jan-25': 2, status: 'active' },
            { label: 'Building CIF/CB', account: '4300324', type: 'Retail', 'Apr-25': 307, 'Mar-25': 306, 'Feb-25': 331, 'Jan-25': 420, status: 'active' },
            { label: 'Building Nursery Building', account: '4300325', type: 'Retail', 'Apr-25': 0, 'Mar-25': 4, 'Feb-25': 4, 'Jan-25': 4, status: 'inactive' },
            { label: 'Cabinet FM (CONTRACTORS OFFICE)', account: '4300337', type: 'MB_Common', 'Apr-25': 58, 'Mar-25': 52, 'Feb-25': 59, 'Jan-25': 68, status: 'active' },
            { label: 'Building CIF/CB (COFFEE SH)', account: '4300339', type: 'Retail', 'Apr-25': 0, 'Mar-25': 0, 'Feb-25': 0, 'Jan-25': 0, status: 'inactive' }
        ]
    },
    'Zone_03_(A)': {
        name: 'Zone 03A',
        'Jan-24': { bulk: 1234, individual: 1041, loss: 193 },
        'Feb-24': { bulk: 1099, individual: 938, loss: 161 },
        'Mar-24': { bulk: 1297, individual: 813, loss: 484 },
        'Apr-24': { bulk: 1892, individual: 1070, loss: 822 },
        'May-24': { bulk: 2254, individual: 1203, loss: 1051 },
        'Jun-24': { bulk: 2227, individual: 1338, loss: 889 },
        'Jul-24': { bulk: 3313, individual: 1671, loss: 1642 },
        'Aug-24': { bulk: 3172, individual: 1923, loss: 1249 },
        'Sep-24': { bulk: 2698, individual: 1580, loss: 1118 },
        'Oct-24': { bulk: 3715, individual: 2271, loss: 1444 },
        'Nov-24': { bulk: 3501, individual: 2140, loss: 1361 },
        'Dec-24': { bulk: 3796, individual: 2333, loss: 1463 },
        'Jan-25': { bulk: 4235, individual: 2486, loss: 1749 },
        'Feb-25': { bulk: 4273, individual: 2548, loss: 1725 },
        'Mar-25': { bulk: 3591, individual: 1929, loss: 1662 },
        'Apr-25': { bulk: 4041, individual: 2168, loss: 1873 },
        meters: [
            { label: 'Z3-42 (Villa)', account: '4300002', type: 'Residential (Villa)', 'Apr-25': 62, 'Mar-25': 19, 'Feb-25': 46, 'Jan-25': 32, status: 'active' },
            { label: 'Z3-46(5) (Building)', account: '4300003', type: 'Residential (Apart)', 'Apr-25': 0, 'Mar-25': 0, 'Feb-25': 0, 'Jan-25': 5, status: 'inactive' },
            { label: 'Z3-49(3) (Building)', account: '4300004', type: 'Residential (Apart)', 'Apr-25': 13, 'Mar-25': 11, 'Feb-25': 15, 'Jan-25': 10, status: 'active' },
            { label: 'Z3-38 (Villa)', account: '4300005', type: 'Residential (Villa)', 'Apr-25': 7, 'Mar-25': 7, 'Feb-25': 7, 'Jan-25': 10, status: 'active' },
            { label: 'Z3-75(4) (Building)', account: '4300006', type: 'Residential (Apart)', 'Apr-25': 0, 'Mar-25': 0, 'Feb-25': 0, 'Jan-25': 0, status: 'inactive' },
            { label: 'Z3-46(3A) (Building)', account: '4300007', type: 'Residential (Apart)', 'Apr-25': 35, 'Mar-25': 15, 'Feb-25': 35, 'Jan-25': 38, status: 'active' },
            { label: 'Z3-049(4) (Building)', account: '4300010', type: 'Residential (Apart)', 'Apr-25': 0, 'Mar-25': 8, 'Feb-25': 1, 'Jan-25': 8, status: 'inactive' },
            { label: 'Z3-46(1A) (Building)', account: '4300011', type: 'Residential (Apart)', 'Apr-25': 11, 'Mar-25': 10, 'Feb-25': 10, 'Jan-25': 11, status: 'active' },
            { label: 'Z3-47(2) (Building)', account: '4300012', type: 'Residential (Apart)', 'Apr-25': 1, 'Mar-25': 1, 'Feb-25': 1, 'Jan-25': 1, status: 'active' },
            { label: 'Z3-45(3A) (Building)', account: '4300013', type: 'Residential (Apart)', 'Apr-25': 1, 'Mar-25': 0, 'Feb-25': 4, 'Jan-25': 8, status: 'active' },
            { label: 'Z3-46(2A) (Building)', account: '4300014', type: 'Residential (Apart)', 'Apr-25': 0, 'Mar-25': 0, 'Feb-25': 0, 'Jan-25': 0, status: 'inactive' },
            { label: 'Z3-46(6) (Building)', account: '4300015', type: 'Residential (Apart)', 'Apr-25': 5, 'Mar-25': 1, 'Feb-25': 1, 'Jan-25': 3, status: 'active' }
        ]
    },
    'Zone_03_(B)': {
        name: 'Zone 03B',
        'Apr-25': { bulk: 2157, individual: 2168, loss: -11 },
        meters: [
            { label: 'Z3-52(6) (Building)', account: '4300008', type: 'Residential (Apart)', 'Apr-25': 14, status: 'active' },
            { label: 'Z3-21 (Villa)', account: '4300009', type: 'Residential (Villa)', 'Apr-25': 48, status: 'active' }
        ]
    },
    'Zone_05': {
        name: 'Zone 05',
        'Apr-25': { bulk: 3737, individual: 1625, loss: 2112 },
        meters: [
            { label: 'Z5-17', account: '4300001', type: 'Residential (Villa)', 'Apr-25': 90, status: 'active' },
            { label: 'Z5-13', account: '4300058', type: 'Residential (Villa)', 'Apr-25': 120, status: 'active' }
        ]
    },
    'Zone_08': {
        name: 'Zone 08',
        'Apr-25': { bulk: 3203, individual: 1053, loss: 2150 },
        meters: [
            { label: 'Z8-12', account: '4300196', type: 'Residential (Villa)', 'Apr-25': 267, status: 'active' },
            { label: 'Z8-5', account: '4300287', type: 'Residential (Villa)', 'Apr-25': 336, status: 'active' }
        ]
    },
    'Zone_VS': {
        name: 'Village Square',
        'Apr-25': { bulk: 13, individual: 15, loss: -2 },
        meters: [
            { label: 'Hotel Main Building', account: '4300334', type: 'Retail', 'Apr-25': 13, status: 'active' },
            { label: 'Coffee 2 (GF Shop No.594 A)', account: '4300329', type: 'Retail', 'Apr-25': 5, status: 'active' }
        ]
    },
    'Main_Bulk': {
        name: 'Main Bulk (A2)',
        'Apr-25': { bulk: 46039, A2: 45863, loss: 176 },
        meters: [
            { label: 'Hotel Main Building', account: '4300334', type: 'Retail', 'Apr-25': 27676, status: 'active' },
            { label: 'Irrigation- Controller UP', account: '4300340', type: 'IRR_Services', 'Apr-25': 1000, status: 'active' },
            { label: 'Al Adrak Camp', account: '4300348', type: 'Retail', 'Apr-25': 1000, status: 'active' },
            { label: 'Al Adrak Construction', account: '4300347', type: 'Retail', 'Apr-25': 600, status: 'active' },
            { label: 'Irrigation- Controller DOWN', account: '4300341', type: 'IRR_Services', 'Apr-25': 411, status: 'active' }
        ]
    }
};

        let selectedPeriod = 'Apr-25';
        let selectedZone = 'Zone_01_(FM)';
        let selectedZoneMonth = 'Apr-25';
        let currentMeterPage = 1;
        let filteredMeters = [];
        const metersPerPage = 12;

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Initialize content when tabs are shown
            if (tabName === 'zones') {
                updateZoneAnalysis();
            } else if (tabName === 'analysis') {
                drawTrendChart();
            } else if (tabName === 'consumers') {
                drawTypeChart();
            }
        }

        // Update calculations
        function updateCalculations() {
            const data = waterData[selectedPeriod];
            const A = data.L1;  // Main bulk
            const B = data.L2 + data.DC;  // Zone bulks + Direct connections
            const C = data.L3 + data.DC;  // End users + Direct connections
            
            const stage1Loss = A - B;
            const stage2Loss = data.L2 - data.L3;  // Loss within zones only
            const totalLoss = A - C;  // Total system loss
            
            const stage1Percentage = (stage1Loss / A * 100).toFixed(1);
            const stage2Percentage = data.L2 > 0 ? (stage2Loss / data.L2 * 100).toFixed(1) : 0;
            const totalPercentage = (totalLoss / A * 100).toFixed(1);
            const efficiency = (100 - totalPercentage).toFixed(1);
            
            // Update DOM elements
            document.getElementById('totalSupply').textContent = A.toLocaleString();
            document.getElementById('totalDistribution').textContent = B.toLocaleString();
            document.getElementById('totalConsumption').textContent = C.toLocaleString();
            
            document.getElementById('stage1Loss').textContent = Math.abs(stage1Loss).toLocaleString();
            document.getElementById('stage1Percentage').textContent = Math.abs(stage1Percentage) + '%';
            document.getElementById('stage2Loss').textContent = stage2Loss.toLocaleString();
            document.getElementById('stage2Percentage').textContent = stage2Percentage + '%';
            document.getElementById('totalLoss').textContent = totalLoss.toLocaleString();
            document.getElementById('totalLossPercentage').textContent = totalPercentage + '%';
            
            // Update progress bars
            document.getElementById('distributionProgress').style.width = (B / A * 100) + '%';
            document.getElementById('consumptionProgress').style.width = (C / A * 100) + '%';
            
            // Update hierarchy
            document.getElementById('hierarchyL1').textContent = A.toLocaleString();
            document.getElementById('hierarchyL2').textContent = data.L2.toLocaleString();
            document.getElementById('hierarchyDC').textContent = data.DC.toLocaleString();
            document.getElementById('hierarchyEndUsers').textContent = C.toLocaleString();
            
            // Update efficiency display
            document.getElementById('efficiencyPercent').textContent = efficiency;
            document.getElementById('efficiencyBar').style.width = efficiency + '%';
            document.getElementById('deliveredPercent').textContent = efficiency + '%';
            document.getElementById('lostPercent').textContent = totalPercentage + '%';
            
            // Update stage bars for loss breakdown
            const totalLossAbs = Math.abs(totalLoss);
            const stage1LossAbs = Math.abs(stage1Loss);
            const stage2LossAbs = Math.abs(stage2Loss);
            
            if (totalLossAbs > 0) {
                const stage1Percent = (stage1LossAbs / totalLossAbs * 100).toFixed(1);
                const stage2Percent = (stage2LossAbs / totalLossAbs * 100).toFixed(1);
                document.getElementById('stage1Bar').style.width = stage1Percent + '%';
                document.getElementById('stage2Bar').style.width = stage2Percent + '%';
            } else {
                document.getElementById('stage1Bar').style.width = '50%';
                document.getElementById('stage2Bar').style.width = '50%';
            }
            
            document.getElementById('stage1Amount').textContent = stage1LossAbs.toLocaleString() + ' m¬≥';
            document.getElementById('stage2Amount').textContent = stage2LossAbs.toLocaleString() + ' m¬≥';
            
            // Update alert based on total loss percentage
            const alertSection = document.getElementById('alertSection');
            alertSection.innerHTML = '';
            
            const totalLossPercent = parseFloat(totalPercentage);
            if (totalLossPercent < 0) {
                alertSection.innerHTML = '<div class="alert alert-success">‚úÖ System showing negative loss - possible meter calibration issue. Please verify readings.</div>';
            } else if (totalLossPercent < 20) {
                alertSection.innerHTML = '<div class="alert alert-success">‚úÖ System efficiency is excellent! Total water loss (' + totalPercentage + '%) is well within industry standards.</div>';
            } else if (totalLossPercent <= 30) {
                alertSection.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è System efficiency needs attention. Total water loss (' + totalPercentage + '%) is approaching the upper limit.</div>';
            } else {
                alertSection.innerHTML = '<div class="alert alert-danger">üö® Critical: Total water loss (' + totalPercentage + '%) exceeds industry standards. Immediate maintenance required.</div>';
            }
            
            // Update period display
            document.getElementById('selectedPeriod').textContent = selectedPeriod;
            
            // Calculate change from previous month
            const periods = ['Nov-24', 'Dec-24', 'Jan-25', 'Feb-25', 'Mar-25', 'Apr-25'];
            const currentIndex = periods.indexOf(selectedPeriod);
            if (currentIndex > 0) {
                const prevPeriod = periods[currentIndex - 1];
                const prevData = waterData[prevPeriod];
                const change = ((A - prevData.L1) / prevData.L1 * 100).toFixed(1);
                const changeElement = document.getElementById('supplyChange');
                if (parseFloat(change) >= 0) {
                    changeElement.textContent = `‚Üë ${change}% from ${prevPeriod}`;
                    changeElement.className = 'metric-change positive';
                } else {
                    changeElement.textContent = `‚Üì ${Math.abs(change)}% from ${prevPeriod}`;
                    changeElement.className = 'metric-change negative';
                }
            }
        }

        // Update zone analysis
        function updateZoneAnalysis() {
            const zone = detailedZoneData[selectedZone];
            if (!zone || !zone[selectedZoneMonth]) return;
            
            const monthData = zone[selectedZoneMonth];
            
            // Update KPI cards
            document.getElementById('zoneBulkReading').textContent = monthData.bulk.toLocaleString();
            
            // For Main_Bulk, use A2 instead of individual
            const distributed = selectedZone === 'Main_Bulk' ? monthData.A2 : monthData.individual;
            document.getElementById('zoneIndividualSum').textContent = distributed.toLocaleString();
            document.getElementById('zoneLoss').textContent = monthData.loss.toLocaleString();
            
            // Calculate loss percentage
            const lossPercentage = monthData.bulk > 0 ? (monthData.loss / monthData.bulk * 100).toFixed(1) : 0;
            document.getElementById('zoneLossPercentage').textContent = lossPercentage + '%';
            
            // Update loss bar
            document.getElementById('zoneLossBar').style.width = Math.abs(lossPercentage) + '%';
            
            // Update performance chart
            updateZonePerformanceChart(monthData);
            
            // Reset pagination when zone/month changes
            currentMeterPage = 1;
            
            // Update meters table
            updateMetersTable(zone.meters);
        }

        // Update zone performance chart
        function updateZonePerformanceChart(monthData) {
            const distributed = selectedZone === 'Main_Bulk' ? monthData.A2 : monthData.individual;
            const maxValue = Math.max(monthData.bulk, distributed, Math.abs(monthData.loss));
            
            document.getElementById('bulkBar').style.height = (monthData.bulk / maxValue * 250) + 'px';
            document.getElementById('bulkBar').querySelector('.bar-value').textContent = monthData.bulk.toLocaleString();
            
            document.getElementById('individualBar').style.height = (distributed / maxValue * 250) + 'px';
            document.getElementById('individualBar').querySelector('.bar-value').textContent = distributed.toLocaleString();
            
            const lossHeight = Math.abs(monthData.loss) / maxValue * 250;
            document.getElementById('lossBar').style.height = lossHeight + 'px';
            document.getElementById('lossBar').querySelector('.bar-value').textContent = monthData.loss.toLocaleString();
        }

        // Update meters table
        function updateMetersTable(meters) {
            const searchTerm = document.getElementById('meterSearch').value.toLowerCase();
            const monthData = detailedZoneData[selectedZone][selectedZoneMonth];
            
            // Filter meters based on search
            filteredMeters = meters.filter(meter => 
                meter.label.toLowerCase().includes(searchTerm) ||
                meter.account.includes(searchTerm)
            );
            
            // Sort meters by consumption (highest first)
            filteredMeters.sort((a, b) => (b[selectedZoneMonth] || 0) - (a[selectedZoneMonth] || 0));
            
            // Update pagination info
            const totalPages = Math.ceil(filteredMeters.length / metersPerPage);
            const startIndex = (currentMeterPage - 1) * metersPerPage;
            const endIndex = Math.min(startIndex + metersPerPage, filteredMeters.length);
            const currentPageMeters = filteredMeters.slice(startIndex, endIndex);
            
            // Build table HTML
            const tbody = document.getElementById('meterTableBody');
            let html = '';
            let totalActive = 0;
            let totalInactive = 0;
            
            currentPageMeters.forEach(meter => {
                const consumption = meter[selectedZoneMonth] || 0;
                const distributed = selectedZone === 'Main_Bulk' ? monthData.A2 : monthData.individual;
                const percentage = distributed > 0 ? (consumption / distributed * 100) : 0;
                const isActive = consumption > 0;
                
                if (isActive) totalActive++; else totalInactive++;
                
                // Determine bar color based on consumption percentage
                let barClass = 'consumption-low';
                if (percentage > 15) barClass = 'consumption-high';
                else if (percentage > 5) barClass = 'consumption-medium';
                
                // Scale the bar width for better visualization (max 90% width)
                const scaledWidth = Math.min((percentage * 2), 90);
                const barWidth = Math.max(scaledWidth, isActive ? 20 : 0);
                
                html += `
                    <tr>
                        <td>${meter.label}</td>
                        <td>${meter.account}</td>
                        <td style="text-align: right; font-weight: ${consumption > 100 ? 'bold' : 'normal'};">
                            ${consumption.toLocaleString()}
                        </td>
                        <td>
                            ${isActive ? `
                                <div class="consumption-bar-container">
                                    <div class="consumption-bar ${barClass}" style="width: ${barWidth}%;">
                                        <span class="consumption-value">${consumption}</span>
                                    </div>
                                </div>
                            ` : `
                                <div style="padding: 2px 8px; color: #999; font-size: 0.9rem;">0</div>
                            `}
                        </td>
                    </tr>
                `;
            });
            
            if (currentPageMeters.length === 0) {
                html = '<tr><td colspan="4" style="text-align: center; color: #666;">No meters found</td></tr>';
            }
            
            tbody.innerHTML = html;
            
            // Update pagination display
            document.getElementById('showingStart').textContent = filteredMeters.length > 0 ? startIndex + 1 : 0;
            document.getElementById('showingEnd').textContent = endIndex;
            document.getElementById('totalMetersCount').textContent = filteredMeters.length;
            document.getElementById('currentPage').textContent = currentMeterPage;
            document.getElementById('totalPages').textContent = Math.max(1, totalPages);
            
            // Update pagination buttons
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            prevBtn.disabled = currentMeterPage === 1;
            nextBtn.disabled = currentMeterPage >= totalPages;
            
            // Count all active/inactive meters in the zone (not just current page)
            let allActive = 0;
            let allInactive = 0;
            filteredMeters.forEach(meter => {
                const consumption = meter[selectedZoneMonth] || 0;
                if (consumption > 0) allActive++; else allInactive++;
            });
            
            // Update meter counts
            document.getElementById('totalMeters').textContent = filteredMeters.length;
            document.getElementById('activeMeters').textContent = allActive;
            document.getElementById('inactiveMeters').textContent = allInactive;
        }

        // Change meter page
        function changeMeterPage(direction) {
            const totalPages = Math.ceil(filteredMeters.length / metersPerPage);
            const newPage = currentMeterPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentMeterPage = newPage;
                updateMetersTable(detailedZoneData[selectedZone].meters);
            }
        }

        // Draw trend chart
        function drawTrendChart() {
            const chartContainer = document.getElementById('trendChart');
            chartContainer.innerHTML = '';
            
            const periods = Object.keys(waterData).reverse().slice(-4);
            const maxValue = Math.max(...periods.map(p => waterData[p].L1));
            
            periods.forEach(period => {
                const data = waterData[period];
                const barContainer = document.createElement('div');
                barContainer.style.position = 'relative';
                barContainer.style.display = 'flex';
                barContainer.style.flexDirection = 'column';
                barContainer.style.alignItems = 'center';
                
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = data.L1 / maxValue * 250 + 'px';
                bar.style.background = period === selectedPeriod ? '#4E4456' : '#A596AD';
                
                const label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = period;
                
                const value = document.createElement('div');
                value.className = 'bar-value';
                value.textContent = (data.L1 / 1000).toFixed(1) + 'k';
                
                bar.appendChild(value);
                barContainer.appendChild(bar);
                barContainer.appendChild(label);
                chartContainer.appendChild(barContainer);
            });
        }

        // Draw type chart
        function drawTypeChart() {
            const chartContainer = document.getElementById('typeChart');
            chartContainer.innerHTML = '';
            
            const typeData = [
                { name: 'Hotel/DC', value: 45863, color: '#4E4456' },
                { name: 'Residential', value: 18000, color: '#7A6B84' },
                { name: 'Retail', value: 4000, color: '#A596AD' },
                { name: 'IRR Services', value: 1166, color: '#C9B8D0' }
            ];
            
            const maxValue = Math.max(...typeData.map(t => t.value));
            
            typeData.forEach(type => {
                const barContainer = document.createElement('div');
                barContainer.style.position = 'relative';
                barContainer.style.display = 'flex';
                barContainer.style.flexDirection = 'column';
                barContainer.style.alignItems = 'center';
                
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = type.value / maxValue * 200 + 'px';
                bar.style.background = type.color;
                bar.style.width = '80px';
                
                const label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = type.name;
                
                const value = document.createElement('div');
                value.className = 'bar-value';
                value.textContent = (type.value / 1000).toFixed(1) + 'k m¬≥';
                
                bar.appendChild(value);
                barContainer.appendChild(bar);
                barContainer.appendChild(label);
                chartContainer.appendChild(barContainer);
            });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize calculations
            updateCalculations();
            
            // Initialize zone analysis 
            updateZoneAnalysis();
            
            // Initialize zone selects if they exist
            const zoneSelect = document.getElementById('zoneSelect');
            const zoneMonthSelect = document.getElementById('zoneMonthSelect');
            const meterSearch = document.getElementById('meterSearch');
            
            if (zoneSelect) {
                zoneSelect.addEventListener('change', function(e) {
                    selectedZone = e.target.value;
                    currentMeterPage = 1; // Reset pagination
                    updateZoneAnalysis();
                });
            }
            
            if (zoneMonthSelect) {
                zoneMonthSelect.addEventListener('change', function(e) {
                    selectedZoneMonth = e.target.value;
                    currentMeterPage = 1; // Reset pagination
                    updateZoneAnalysis();
                });
            }
            
            if (meterSearch) {
                meterSearch.addEventListener('input', function(e) {
                    currentMeterPage = 1; // Reset to first page when searching
                    if (detailedZoneData[selectedZone]) {
                        updateMetersTable(detailedZoneData[selectedZone].meters);
                    }
                });
            }

            // Period change handler
            document.getElementById('periodSelect').addEventListener('change', function(e) {
                selectedPeriod = e.target.value;
                updateCalculations();
            });
        });
    </script>
</body>
</html>